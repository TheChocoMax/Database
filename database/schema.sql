-- Enums & Types

CREATE TYPE delivery_type AS ENUM ('pickup', 'delivery');

CREATE TYPE pagination_info AS (
    current_page INTEGER,
    page_size INTEGER,          -- Default is 12 for listings, 24 for search, 36 for admin
    total_items BIGINT,
    total_pages INTEGER,
    has_next BOOLEAN,
    has_previous BOOLEAN
);

-- Languages (i18n) - followed by translation tables later in the schema

CREATE TABLE languages (
    language_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    iso_code CHAR(2) UNIQUE,
    english_name TEXT UNIQUE CHECK (english_name ~ '^[A-Za-z ]+$'),
    native_name TEXT UNIQUE
);

-- Product & Interaction Tables

CREATE TABLE products (
    product_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_name TEXT NOT NULL,
    product_description TEXT,
    price NUMERIC(10, 2) NOT NULL CHECK (price >= 0),
    image_url TEXT,
    is_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp)
);

CREATE TABLE product_categories (
    product_category_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_category_name TEXT NOT NULL UNIQUE,
    product_category_description TEXT,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp)
);

CREATE TABLE product_variants (
    product_variant_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products (product_id) ON DELETE CASCADE,
    size TEXT,
    is_test BOOLEAN DEFAULT FALSE,
    price_override NUMERIC(10, 2) CHECK (price_override >= 0),
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp)
);

CREATE TABLE product_images (
    product_image_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products (product_id) ON DELETE CASCADE,
    variant_id INTEGER REFERENCES product_variants (product_variant_id) ON DELETE SET NULL,
    image_url TEXT NOT NULL,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp)
);

-- Internationalization (i18n)

CREATE TABLE translations (
    translation_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    translation_key TEXT NOT NULL UNIQUE CHECK (translation_key ~ '^[a-z0-9_.]+$'), -- Key must be lowercase alphanumeric with underscores and dots
    language_id INTEGER NOT NULL REFERENCES languages (language_id) ON DELETE CASCADE,
    translation_value TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp),
    UNIQUE (translation_key, language_id)
);

CREATE TABLE product_translations (
    product_translation_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products (product_id) ON DELETE CASCADE,
    language_id INTEGER NOT NULL REFERENCES languages (language_id) ON DELETE CASCADE,
    product_name TEXT NOT NULL,
    product_description TEXT,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp),
    UNIQUE (product_id, language_id)
);

CREATE TABLE category_translations (
    category_translation_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    category_id INTEGER NOT NULL REFERENCES product_categories (product_category_id) ON DELETE CASCADE,
    language_id INTEGER NOT NULL REFERENCES languages (language_id) ON DELETE CASCADE,
    category_name TEXT NOT NULL,
    category_description TEXT,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp),
    UNIQUE (category_id, language_id)
);

-- Support & Feedback

CREATE TABLE contact_messages (
    contact_message_id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    contact_name TEXT NOT NULL,
    contact_email TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT current_timestamp,
    updated_at TIMESTAMPTZ CHECK (updated_at <= current_timestamp)
);

-- Products table indexes
CREATE INDEX idx_products_enabled ON products (is_enabled) WHERE is_enabled = TRUE;
CREATE INDEX idx_products_price ON products (price);
CREATE INDEX idx_products_created_at ON products (created_at DESC);
CREATE INDEX idx_products_updated_at ON products (updated_at DESC);
CREATE INDEX idx_products_enabled_price ON products (is_enabled, price) WHERE is_enabled = TRUE;

-- Product variants indexes
CREATE INDEX idx_product_variants_product_id ON product_variants (product_id);
CREATE INDEX idx_product_variants_non_test ON product_variants (product_id) WHERE is_test = FALSE;
CREATE INDEX idx_product_variants_size ON product_variants (size);

-- Product images indexes
CREATE INDEX idx_product_images_product_id ON product_images (product_id);
CREATE INDEX idx_product_images_variant_id ON product_images (variant_id) WHERE variant_id IS NOT NULL;
CREATE INDEX idx_product_images_primary ON product_images (product_id, is_primary) WHERE is_primary = TRUE;

-- Product categories indexes (for future category filtering)
CREATE INDEX idx_product_categories_name ON product_categories (product_category_name);

-- Internationalization indexes
CREATE INDEX idx_translations_key_lang ON translations (translation_key, language_id);
CREATE INDEX idx_translations_language ON translations (language_id);

CREATE INDEX idx_product_translations_product_lang ON product_translations (product_id, language_id);
CREATE INDEX idx_product_translations_language ON product_translations (language_id);

CREATE INDEX idx_category_translations_category_lang ON category_translations (category_id, language_id);
CREATE INDEX idx_category_translations_language ON category_translations (language_id);

-- Languages index for i18n lookups
CREATE INDEX idx_languages_iso_code ON languages (iso_code);

-- Full-text search indexes
CREATE INDEX idx_products_search ON products USING gin (to_tsvector('english', product_name || ' ' || coalesce(product_description, '')));
CREATE INDEX idx_product_translations_search ON product_translations USING gin (to_tsvector('english', product_name || ' ' || coalesce(product_description, '')));

-- Composite indexes for common query patterns
CREATE INDEX idx_products_enabled_created ON products (is_enabled, created_at DESC) WHERE is_enabled = TRUE;
CREATE INDEX idx_products_enabled_price_created ON products (is_enabled, price, created_at DESC) WHERE is_enabled = TRUE;
